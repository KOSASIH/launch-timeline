<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../launch-vehicle-elements/payload-dragon/payload-dragon.html">
<link rel="import" href="../launch-vehicle-elements/launch-vehicle/launch-vehicle.html">

<dom-module id="spacex-launch">
  <template>
    <link rel="stylesheet" href="[[importPath]]/spacex-launch.css">
    <p id="mission">[[launchData.payloads.0.payload_id]]</p>
    <p id="customer">[[customerString(launchData.payloads.0)]]</p>
    <time id="launchDatetime" datetime="[[launchData.launch_date_local]]"
        title="[[launchData.launch_date_local]]"></time>
    <p id="launchSite"></p>
    <launch-vehicle payload-type="[[launchData.payloads.0.payload_type]]"
                    vehicle-data="[[launchData.rocket]]"
                    landing-attempt="[[hasLanding(launchData)]]"
                    core-serial="[[launchData.core_serial]]"></launch-vehicle>
    <h2>[[launchData.flight_number]]</h2>
  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
     class SpaceXLaunch extends Polymer.Element {
       static get is() { return 'spacex-launch'; }
       static get properties() {
         return {
           launchData: {
             type: Object,
             reflectToAttribute: true,
             observer: '_dataChanged'
           },
           launchYear: {
             type: Number,
             computed: 'getLaunchYear(launchData)'
           }
         };
       }

       constructor(_launchData) {
         super();
         this.launchData = _launchData;
       }

       ready() {
         super.ready();
         this.render(this.launchData, this);
       }

       fetchData(launchNum, callback) {
         fetch(`https://v2-test.herokuapp.com/v2/launches?flight_number=${launchNum}`).then((res) => {
           return res.json();
         }).then((json) => {
           callback(json[0], this);
         }).catch((err) => {
           console.error(err);
         });
       }

       render(data, el) {
         let dom = el.shadowRoot;

         let launchDate = new Date(data.launch_date_local);
         let datetime = dom.querySelector('#launchDatetime');
         datetime.textContent = launchDate.toLocaleDateString(navigator.userLanguage, {month: 'short', day: '2-digit'});
       }

       _dataChanged(newValue, oldValue) {
         this.render(newValue, this);
       }

       customerString(payload) {
         return payload.customers.join('/');
       }

       hasLanding(data){
         return (data.landing_type != null && data.landing_type != "Ocean");
       }

       getLaunchYear(launch) {
         return parseInt(launch.launch_year);
       }
     }

     window.customElements.define(SpaceXLaunch.is, SpaceXLaunch);
  </script>
</dom-module>
